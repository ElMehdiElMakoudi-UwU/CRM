{% extends 'mobile_pos/base.html' %}
{% load static %}

{% block inner_title %}New Order{% endblock %}
{% block header_title %}Create New Order{% endblock %}

{% block inner_content %}
<form method="post" id="orderForm" class="space-y-6">
    {% csrf_token %}
    
    <!-- Client Information -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Client Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="client_name" class="block text-sm font-medium text-gray-700 mb-1">Client Name</label>
                    <input type="text" id="client_name" name="client_name" required
                           class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="client_contact" class="block text-sm font-medium text-gray-700 mb-1">Client Contact</label>
                    <input type="text" id="client_contact" name="client_contact" required
                           class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea id="notes" name="notes" rows="2"
                              class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Items -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Order Items</h3>
            <div id="orderItems" class="space-y-4">
                <!-- Order items will be added here -->
            </div>
            <button type="button" id="addItem"
                    class="mt-4 inline-flex items-center px-4 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors">
                <span class="mr-2">âž•</span> Add Item
            </button>
        </div>
    </div>

    <!-- Order Summary -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="p-6">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">Total Amount</h3>
                <p class="text-2xl font-bold text-gray-900"><span id="totalAmount">0.00</span> MAD</p>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="flex justify-between">
        <a href="{% url 'mobile_pos:order_list' %}" 
           class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
            Cancel
        </a>
        <button type="submit"
                class="inline-flex items-center px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition-colors">
            Create Order
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// This block contains any external JavaScript libraries we might need
</script>
{% endblock %}

{% block inline_js %}
var productsData = [
{% for product in products %}
    {
        id: {{ product.id }},
        name: "{{ product.name|escapejs }}",
        price: {{ product.selling_price|stringformat:".2f" }}
    }{% if not forloop.last %},{% endif %}
{% endfor %}
];

function createOrderItem() {
    var itemDiv = document.createElement('div');
    itemDiv.className = 'bg-gray-50 rounded-lg p-4';

    var productOptions = productsData.map(function(p) {
        return '<option value="' + p.id + '" data-price="' + p.price + '">' + p.name + ' - ' + p.price + ' MAD</option>';
    }).join('');

    itemDiv.innerHTML = [
        '<div class="grid grid-cols-1 md:grid-cols-12 gap-4">',
            '<div class="md:col-span-6">',
                '<label class="block text-sm font-medium text-gray-700 mb-1">Product</label>',
                '<select class="product-select w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500" name="product_id[]" required>',
                    '<option value="">Select a product</option>',
                    productOptions,
                '</select>',
            '</div>',
            '<div class="md:col-span-4">',
                '<label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>',
                '<input type="number" class="quantity-input w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500" name="quantity[]" value="1" min="1" required>',
            '</div>',
            '<div class="md:col-span-2">',
                '<label class="block text-sm font-medium text-gray-700 mb-1">&nbsp;</label>',
                '<button type="button" class="remove-item w-full px-3 py-2 border border-red-600 text-red-600 rounded-lg hover:bg-red-50 transition-colors">',
                    'Remove',
                '</button>',
            '</div>',
        '</div>'
    ].join('');

    var removeBtn = itemDiv.querySelector('.remove-item');
    if (removeBtn) {
        removeBtn.addEventListener('click', function() {
            itemDiv.remove();
            updateTotal();
        });
    }

    var productSelect = itemDiv.querySelector('.product-select');
    var quantityInput = itemDiv.querySelector('.quantity-input');
    
    if (productSelect && quantityInput) {
        productSelect.addEventListener('change', updateTotal);
        quantityInput.addEventListener('change', updateTotal);
        quantityInput.addEventListener('input', updateTotal);
    }

    return itemDiv;
}

function updateTotal() {
    var total = 0;
    var orderItems = document.querySelectorAll('.product-select');
    
    orderItems.forEach(function(select) {
        if (select && select.closest('.bg-gray-50')) {
            var quantityInput = select.closest('.bg-gray-50').querySelector('.quantity-input');
            var quantity = parseInt(quantityInput ? quantityInput.value : 0) || 0;
            var selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.value && selectedOption.dataset.price) {
                var price = parseFloat(selectedOption.dataset.price);
                total += price * quantity;
            }
        }
    });

    var totalElement = document.getElementById('totalAmount');
    if (totalElement) {
        totalElement.textContent = total.toFixed(2);
    }
}

var addItemButton = document.getElementById('addItem');
var orderItemsContainer = document.getElementById('orderItems');

if (addItemButton && orderItemsContainer) {
    addItemButton.addEventListener('click', function() {
        orderItemsContainer.appendChild(createOrderItem());
        updateTotal();
    });

    // Add initial item
    addItemButton.click();
}
{% endblock %} 